image: node:latest
include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

stages:
  - build
  - test
  - release

install:
  stage: build
  script:
    - npm install
  artifacts:
    expire_in: 10 minutes
    when: on_success
    paths:
      - node_modules/

unit-test:
  stage: test
  script:
    - npm run lint
    - npm audit --audit-level=low
    - npm run test

e2e-test:
  stage: test
  image: docker
  variables:
    TEST_URL: http://localhost:3000
    TESTING_ENVIRONMENT: dev
    REMOTE_URL: http://localhost:4444/wd/hub
    NODE_ENV: test
  services:
    - docker:dind
  before_script:
    - apk update
    - apk add --no-cache git
  script:
    - git clone -b staging --single-branch "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/loginid/software/testing-tools/auto-directweb.git" ../auto-directweb
    - cd ../auto-directweb
    - mv ../websdk3 ./web
    - docker build -t test-suite -f Dockerfile.dev.integration.test .
    - >
      docker run --rm --name test-suite
      -e TEST_URL="$TEST_URL"
      -e TESTING_ENVIRONMENT="$TESTING_ENVIRONMENT"
      -e MAILSLURP_API_KEY="$MAILSLURP_API_KEY"
      -e SE_NODE_MAX_SESSIONS="2"
      -e SE_NODE_OVERRIDE_MAX_SESSIONS="true"
      -e NODE_ENV="$NODE_ENV"
      -e SE_OPTS="--log-level INFO"
      -e REMOTE_URL="$REMOTE_URL" test-suite

release:
  stage: release
  image: node:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  variables:
    GITLAB_TOKEN: $PROJECT_CI_TOKEN
    NPM_TOKEN: $NPM_AUTH_TOKEN
  script:
    - npm run build
    - npm run delete-maps
    - npm i -g semantic-release @semantic-release/gitlab @semantic-release/changelog @semantic-release/git @semantic-release/npm @semantic-release/commit-analyzer conventional-changelog-conventionalcommits
    - npx semantic-release
